name: Cleanup old workflow runs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * 1" # weekly; bi-weekly gate below

permissions:
  actions: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Bi-weekly gate (run only on even ISO weeks)
        run: |
          set -euo pipefail
          week="$(date -u +%V)"
          if [ $((10#$week % 2)) -ne 0 ]; then
            echo "Odd ISO week ($week). Skipping (bi-weekly gate)."
            exit 0
          fi
          echo "Even ISO week ($week). Continuing."

      - name: Delete all but most recent run of selected workflows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYNC_WORKFLOW_FILE: sync_upstream_vulkan_headers.yml
          CLEANUP_WORKFLOW_FILE: cleanup_sync_runs.yml
        run: |
          set -euo pipefail

          repo="${GITHUB_REPOSITORY}"

          resolve_wf_id_by_path_suffix() {
            local want_file="$1"
            gh api "repos/${repo}/actions/workflows?per_page=100" \
              --jq ".workflows[] | select(.path | endswith(\"/${want_file}\")) | .id" \
              | head -n 1
          }

          delete_all_but_latest_by_file() {
            local workflow_file="$1"

            local wf_id
            wf_id="$(resolve_wf_id_by_path_suffix "$workflow_file" || true)"
            if [ -z "${wf_id:-}" ]; then
              echo "Could not find workflow with path ending in /${workflow_file}"
              echo "Check the filename under .github/workflows/ exactly matches."
              return 1
            fi

            local keep_id
            keep_id="$(gh api "repos/${repo}/actions/workflows/${wf_id}/runs?per_page=100" --jq '.workflow_runs[0].id // empty')"
            if [ -z "${keep_id:-}" ]; then
              echo "No workflow runs found for ${workflow_file}. Nothing to do."
              return 0
            fi

            local delete_ids
            delete_ids="$(gh api "repos/${repo}/actions/workflows/${wf_id}/runs?per_page=100" \
              --jq ".workflow_runs[] | select(.id != ${keep_id}) | select(.status == \"completed\") | .id")"

            echo "Workflow: ${workflow_file}"
            echo "Keeping most recent run id: ${keep_id}"

            if [ -z "${delete_ids:-}" ]; then
              echo "Nothing to delete for ${workflow_file}."
              return 0
            fi

            echo "Deleting completed run ids:"
            echo "${delete_ids}"

            while IFS= read -r run_id; do
              [ -n "$run_id" ] || continue
              gh api -X DELETE "repos/${repo}/actions/runs/${run_id}"
              echo "Deleted run ${run_id}"
            done <<< "${delete_ids}"
          }

          delete_all_but_latest_by_file "${SYNC_WORKFLOW_FILE}"
          delete_all_but_latest_by_file "${CLEANUP_WORKFLOW_FILE}"