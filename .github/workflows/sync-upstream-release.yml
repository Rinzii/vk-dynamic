name: Sync upstream releases and publish release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * 1"

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (default branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name vk-dynamic-sync-bot
          git config user.email actions@users.noreply.github.com

      - name: Fetch tags and branches
        run: |
          git fetch --tags --force --prune origin +refs/heads/*:refs/remotes/origin/*

      - name: Get last local release tag (vVK-GL)
        id: local
        run: |
          set -euo pipefail

          last_tag=$(git tag -l 'v*' --sort=-v:refname | head -n 1 || true)
          echo "last_tag=$last_tag" >> "$GITHUB_OUTPUT"

          last_vk=""
          last_gl=""
          if [ -n "$last_tag" ] && echo "$last_tag" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+$'; then
            last_vk="$(echo "$last_tag" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+\.[0-9]+\.[0-9]+)$/\1/')"
            last_gl="$(echo "$last_tag" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+\.[0-9]+\.[0-9]+)$/\2/')"
          fi

          echo "last_vk=$last_vk" >> "$GITHUB_OUTPUT"
          echo "last_gl=$last_gl" >> "$GITHUB_OUTPUT"

      - name: Get latest upstream version-number tags
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          get_latest_matching_tag() {
            owner_repo="$1"
            jq_filter="$2"
            gh api "repos/${owner_repo}/tags?per_page=100" --jq "$jq_filter"
          }

          vk_tag="$(get_latest_matching_tag \
            "KhronosGroup/Vulkan-Headers" \
            '[.[].name | select(test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))][0] // empty')"

          gl_tag="$(get_latest_matching_tag \
            "KhronosGroup/glslang" \
            '[.[].name | select(test("^v?[0-9]+\\.[0-9]+\\.[0-9]+$"))][0] // empty')"

          if [ -z "$vk_tag" ] || [ -z "$gl_tag" ]; then
            echo Failed to find version-number tags
            echo Vulkan-Headers: "$vk_tag"
            echo glslang: "$gl_tag"
            exit 1
          fi

          vk_ver="${vk_tag#v}"
          gl_ver="${gl_tag#v}"

          echo "vk_tag=$vk_tag" >> "$GITHUB_OUTPUT"
          echo "gl_tag=$gl_tag" >> "$GITHUB_OUTPUT"
          echo "vk_ver=$vk_ver" >> "$GITHUB_OUTPUT"
          echo "gl_ver=$gl_ver" >> "$GITHUB_OUTPUT"

      - name: Compute release ref vVK-GL
        id: plan
        run: |
          set -euo pipefail

          last_vk="${{ steps.local.outputs.last_vk }}"
          last_gl="${{ steps.local.outputs.last_gl }}"

          up_vk="${{ steps.upstream.outputs.vk_ver }}"
          up_gl="${{ steps.upstream.outputs.gl_ver }}"

          use_vk="$up_vk"
          use_gl="$up_gl"

          if [ -z "$use_vk" ]; then use_vk="$last_vk"; fi
          if [ -z "$use_gl" ]; then use_gl="$last_gl"; fi

          if [ -z "$use_vk" ] || [ -z "$use_gl" ]; then
            echo Could not determine release versions
            exit 1
          fi

          release_ref="v${use_vk}-${use_gl}"

          echo "use_vk=$use_vk" >> "$GITHUB_OUTPUT"
          echo "use_gl=$use_gl" >> "$GITHUB_OUTPUT"
          echo "release_ref=$release_ref" >> "$GITHUB_OUTPUT"

      - name: Check whether release branch exists on origin
        id: branchcheck
        run: |
          set -euo pipefail
          release_ref="${{ steps.plan.outputs.release_ref }}"

          if git ls-remote --heads origin "$release_ref" | grep -q .; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: If release branch exists, checkout it (for CMake correction only)
        if: steps.branchcheck.outputs.exists == 'true'
        run: |
          set -euo pipefail
          release_ref="${{ steps.plan.outputs.release_ref }}"
          git checkout -B "$release_ref" "origin/$release_ref"

      - name: If release branch exists, ensure CMake versioning is correct and push if needed
        if: steps.branchcheck.outputs.exists == 'true'
        run: |
          set -euo pipefail

          vk_ver="${{ steps.plan.outputs.use_vk }}"
          gl_ver="${{ steps.plan.outputs.use_gl }}"
          release_ref="${{ steps.plan.outputs.release_ref }}"

          if [ ! -f CMakeLists.txt ]; then
            echo CMakeLists.txt not found
            exit 1
          fi

          perl -0777 -i -pe "s/(project\\(\\s*vk-dynamic\\b[^\\)]*\\bVERSION\\s+)[0-9]+\\.[0-9]+\\.[0-9]+/\\1${vk_ver}/s" CMakeLists.txt

          if grep -q 'VK_DYNAMIC_VULKAN_HEADERS_VERSION' CMakeLists.txt; then
            perl -0777 -i -pe "s/set\\(\\s*VK_DYNAMIC_VULKAN_HEADERS_VERSION\\s+\\\"?[^\\\"\\)]+\\\"?\\s*\\)/set(VK_DYNAMIC_VULKAN_HEADERS_VERSION \"${vk_ver}\")/s" CMakeLists.txt
          fi
          if grep -q 'VK_DYNAMIC_GLSLANG_VERSION' CMakeLists.txt; then
            perl -0777 -i -pe "s/set\\(\\s*VK_DYNAMIC_GLSLANG_VERSION\\s+\\\"?[^\\\"\\)]+\\\"?\\s*\\)/set(VK_DYNAMIC_GLSLANG_VERSION \"${gl_ver}\")/s" CMakeLists.txt
          fi
          if grep -q 'VK_DYNAMIC_RELEASE_REF' CMakeLists.txt; then
            perl -0777 -i -pe "s/set\\(\\s*VK_DYNAMIC_RELEASE_REF\\s+\\\"?[^\\\"\\)]+\\\"?\\s*\\)/set(VK_DYNAMIC_RELEASE_REF \"${release_ref}\")/s" CMakeLists.txt
          fi

          if ! grep -q 'VK_DYNAMIC_VULKAN_HEADERS_VERSION' CMakeLists.txt; then
            perl -0777 -i -pe "s/(project\\([^\\)]*\\)\\s*)/\\1\\nset(VK_DYNAMIC_VULKAN_HEADERS_VERSION \"${vk_ver}\")\\nset(VK_DYNAMIC_GLSLANG_VERSION \"${gl_ver}\")\\nset(VK_DYNAMIC_RELEASE_REF \"${release_ref}\")\\n/s" CMakeLists.txt
          fi

          if git status --porcelain | grep -q .; then
            git add CMakeLists.txt
            git commit -m "Fix CMake versioning for ${release_ref}"
            git push origin "$release_ref"
          else
            echo CMakeLists already correct, doing nothing
          fi

      - name: Stop after CMake correction when branch exists
        if: steps.branchcheck.outputs.exists == 'true'
        run: |
          echo Release branch already exists, no vendor or release work performed

      - name: Checkout base for sync (last tag if present)
        if: steps.branchcheck.outputs.exists != 'true'
        run: |
          set -euo pipefail
          if [ -n "${{ steps.local.outputs.last_tag }}" ]; then
            git checkout -B sync-work "${{ steps.local.outputs.last_tag }}"
          else
            git checkout -B sync-work
          fi

      - name: Vendor Vulkan-Headers include/vulkan and include/vk_video only
        if: steps.branchcheck.outputs.exists != 'true'
        run: |
          set -euo pipefail

          vk_tag="${{ steps.upstream.outputs.vk_tag }}"
          url="https://github.com/KhronosGroup/Vulkan-Headers/archive/refs/tags/${vk_tag}.tar.gz"

          tmp=$(mktemp -d)
          curl -L "$url" -o "$tmp/vkheaders.tgz"
          tar -xzf "$tmp/vkheaders.tgz" -C "$tmp"

          src_dir=$(find "$tmp" -maxdepth 1 -type d -name "Vulkan-Headers-*" | head -n 1)
          if [ -z "$src_dir" ]; then
            echo Expected Vulkan-Headers source directory not found
            exit 1
          fi

          if [ ! -d "$src_dir/include/vulkan" ] || [ ! -d "$src_dir/include/vk_video" ]; then
            echo Expected include/vulkan or include/vk_video not found in Vulkan-Headers tarball
            exit 1
          fi

          rm -rf include/vulkan include/vk_video
          mkdir -p include/vulkan include/vk_video

          rsync -a --delete "$src_dir/include/vulkan/" "include/vulkan/"
          rsync -a --delete "$src_dir/include/vk_video/" "include/vk_video/"

      - name: Vendor selected glslang subtree items only
        if: steps.branchcheck.outputs.exists != 'true'
        run: |
          set -euo pipefail

          gl_tag="${{ steps.upstream.outputs.gl_tag }}"
          url="https://github.com/KhronosGroup/glslang/archive/refs/tags/${gl_tag}.tar.gz"

          tmp=$(mktemp -d)
          curl -L "$url" -o "$tmp/glslang.tgz"
          tar -xzf "$tmp/glslang.tgz" -C "$tmp"

          src_dir=$(find "$tmp" -maxdepth 1 -type d -name "glslang-*" | head -n 1)
          if [ -z "$src_dir" ]; then
            echo Expected glslang source directory not found
            exit 1
          fi

          dirs_needed=(
            CInterface
            ExtensionHeaders
            GenericCodeGen
            HLSL
            Include
            MachineIndependent
            OSDependent
            Public
            ResourceLimits
          )

          files_needed=(
            CMakeLists.txt
            stub.cpp
            updateGrammar
          )

          is_base_ok() {
            base="$1"
            for d in "${dirs_needed[@]}"; do
              [ -d "$base/$d" ] || return 1
            done
            for f in "${files_needed[@]}"; do
              [ -e "$base/$f" ] || return 1
            done
            return 0
          }

          base=""
          candidates=(
            "$src_dir/glslang/glslang"
            "$src_dir/glslang"
            "$src_dir"
          )

          for c in "${candidates[@]}"; do
            if [ -d "$c" ] && is_base_ok "$c"; then
              base="$c"
              break
            fi
          done

          if [ -z "$base" ]; then
            found_ci="$(find "$src_dir" -maxdepth 6 -type d -name CInterface | head -n 1 || true)"
            if [ -n "$found_ci" ]; then
              maybe_base="$(dirname "$found_ci")"
              if is_base_ok "$maybe_base"; then
                base="$maybe_base"
              fi
            fi
          fi

          if [ -z "$base" ]; then
            echo Could not locate glslang base directory containing the expected subtree
            exit 1
          fi

          rm -rf include/glslang/glslang
          mkdir -p include/glslang/glslang

          for d in "${dirs_needed[@]}"; do
            rsync -a --delete "$base/$d/" "include/glslang/glslang/$d/"
          done

          install -m 0644 "$base/CMakeLists.txt" "include/glslang/glslang/CMakeLists.txt"
          install -m 0644 "$base/stub.cpp" "include/glslang/glslang/stub.cpp"
          install -m 0755 "$base/updateGrammar" "include/glslang/glslang/updateGrammar"

      - name: Update CMakeLists.txt versioning
        if: steps.branchcheck.outputs.exists != 'true'
        run: |
          set -euo pipefail

          vk_ver="${{ steps.plan.outputs.use_vk }}"
          gl_ver="${{ steps.plan.outputs.use_gl }}"
          release_ref="${{ steps.plan.outputs.release_ref }}"

          if [ ! -f CMakeLists.txt ]; then
            echo CMakeLists.txt not found
            exit 1
          fi

          perl -0777 -i -pe "s/(project\\(\\s*vk-dynamic\\b[^\\)]*\\bVERSION\\s+)[0-9]+\\.[0-9]+\\.[0-9]+/\\1${vk_ver}/s" CMakeLists.txt

          if grep -q 'VK_DYNAMIC_VULKAN_HEADERS_VERSION' CMakeLists.txt; then
            perl -0777 -i -pe "s/set\\(\\s*VK_DYNAMIC_VULKAN_HEADERS_VERSION\\s+\\\"?[^\\\"\\)]+\\\"?\\s*\\)/set(VK_DYNAMIC_VULKAN_HEADERS_VERSION \"${vk_ver}\")/s" CMakeLists.txt
          fi
          if grep -q 'VK_DYNAMIC_GLSLANG_VERSION' CMakeLists.txt; then
            perl -0777 -i -pe "s/set\\(\\s*VK_DYNAMIC_GLSLANG_VERSION\\s+\\\"?[^\\\"\\)]+\\\"?\\s*\\)/set(VK_DYNAMIC_GLSLANG_VERSION \"${gl_ver}\")/s" CMakeLists.txt
          fi
          if grep -q 'VK_DYNAMIC_RELEASE_REF' CMakeLists.txt; then
            perl -0777 -i -pe "s/set\\(\\s*VK_DYNAMIC_RELEASE_REF\\s+\\\"?[^\\\"\\)]+\\\"?\\s*\\)/set(VK_DYNAMIC_RELEASE_REF \"${release_ref}\")/s" CMakeLists.txt
          fi

          if ! grep -q 'VK_DYNAMIC_VULKAN_HEADERS_VERSION' CMakeLists.txt; then
            perl -0777 -i -pe "s/(project\\([^\\)]*\\)\\s*)/\\1\\nset(VK_DYNAMIC_VULKAN_HEADERS_VERSION \"${vk_ver}\")\\nset(VK_DYNAMIC_GLSLANG_VERSION \"${gl_ver}\")\\nset(VK_DYNAMIC_RELEASE_REF \"${release_ref}\")\\n/s" CMakeLists.txt
          fi

      - name: Reapply local patches if present
        if: steps.branchcheck.outputs.exists != 'true'
        run: |
          set -euo pipefail
          if ls patches/*.patch >/dev/null 2>&1; then
            git am --3way patches/*.patch
          else
            echo No patches found, skipping
          fi

      - name: Commit changes on versioned release branch
        if: steps.branchcheck.outputs.exists != 'true'
        run: |
          set -euo pipefail

          release_ref="${{ steps.plan.outputs.release_ref }}"
          vk_tag="${{ steps.upstream.outputs.vk_tag }}"
          gl_tag="${{ steps.upstream.outputs.gl_tag }}"

          git checkout -B "$release_ref"

          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "Sync Vulkan-Headers ${vk_tag} and glslang ${gl_tag}"
          else
            echo No changes to commit
          fi

          git push -f origin "$release_ref"

      - name: Create tag and GitHub Release vVK-GL
        if: steps.branchcheck.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          release_ref="${{ steps.plan.outputs.release_ref }}"
          vk_tag="${{ steps.upstream.outputs.vk_tag }}"
          gl_tag="${{ steps.upstream.outputs.gl_tag }}"
          last_tag="${{ steps.local.outputs.last_tag }}"

          printf "%s\n" \
            "Automated vendor sync to upstream versions." \
            "" \
            "Previous local release: ${last_tag}" \
            "" \
            "Upstream Vulkan-Headers: ${vk_tag}" \
            "Upstream glslang: ${gl_tag}" \
            "" \
            "Release ref: ${release_ref}" \
            "" \
            "Vendored paths updated:" \
            "include/vulkan" \
            "include/vk_video" \
            "include/glslang/glslang with selected items" \
            "" \
            "CMake updated:" \
            "project VERSION set to Vulkan-Headers version" \
            "VK_DYNAMIC_VULKAN_HEADERS_VERSION, VK_DYNAMIC_GLSLANG_VERSION, VK_DYNAMIC_RELEASE_REF set" \
            > release_notes.txt

          if ! git rev-parse "$release_ref" >/dev/null 2>&1; then
            git tag -a "$release_ref" -m "Sync to Vulkan-Headers ${vk_tag} and glslang ${gl_tag}"
            git push origin "$release_ref"
          fi

          if gh release view "$release_ref" >/dev/null 2>&1; then
            echo Release already exists
            exit 0
          fi

          gh release create "$release_ref" \
            --title "Vulkan-Headers ${vk_tag} and glslang ${gl_tag}" \
            --notes-file release_notes.txt