name: Cleanup old workflow runs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * 1"

permissions:
  actions: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Bi-weekly gate (run only on even ISO weeks)
        run: |
          set -euo pipefail
          week="$(date -u +%V)"
          if [ $((10#$week % 2)) -ne 0 ]; then
            echo "Odd ISO week ($week). Skipping (bi-weekly gate)."
            exit 0
          fi
          echo "Even ISO week ($week). Continuing."

      - name: Delete all but most recent run of selected workflows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYNC_WORKFLOW_NAME: Sync upstream Vulkan-Headers and publish release
          CLEANUP_WORKFLOW_NAME: Cleanup old workflow runs
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"

          resolve_wf_id_by_name() {
            local want_name="$1"
            gh api "repos/${repo}/actions/workflows?per_page=100" \
              --jq ".workflows[] | select(.name == \"${want_name}\") | .id" \
              | head -n 1
          }

          delete_all_but_latest_by_name() {
            local wf_name="$1"

            local wf_id
            wf_id="$(resolve_wf_id_by_name "$wf_name" || true)"
            if [ -z "${wf_id:-}" ]; then
              echo "Could not find workflow with name: ${wf_name}"
              echo "Fix SYNC_WORKFLOW_NAME and CLEANUP_WORKFLOW_NAME to exactly match the workflow name fields."
              return 1
            fi

            local keep_id
            keep_id="$(gh api "repos/${repo}/actions/workflows/${wf_id}/runs?per_page=100" --jq '.workflow_runs[0].id // empty')"
            if [ -z "${keep_id:-}" ]; then
              echo "No workflow runs found for ${wf_name}. Nothing to do."
              return 0
            fi

            local delete_ids
            delete_ids="$(gh api "repos/${repo}/actions/workflows/${wf_id}/runs?per_page=100" \
              --jq ".workflow_runs[] | select(.id != ${keep_id}) | select(.status == \"completed\") | .id")"

            echo "Workflow: ${wf_name}"
            echo "Keeping most recent run id: ${keep_id}"

            if [ -z "${delete_ids:-}" ]; then
              echo "Nothing to delete for ${wf_name}."
              return 0
            fi

            echo "Deleting completed run ids:"
            echo "${delete_ids}"

            while IFS= read -r run_id; do
              [ -n "$run_id" ] || continue
              gh api -X DELETE "repos/${repo}/actions/runs/${run_id}"
              echo "Deleted run ${run_id}"
            done <<< "${delete_ids}"
          }

          delete_all_but_latest_by_name "${SYNC_WORKFLOW_NAME}"
          delete_all_but_latest_by_name "${CLEANUP_WORKFLOW_NAME}"